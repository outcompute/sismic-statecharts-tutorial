statechart:
  name: chapter_02
  description: A vault that checks a PIN code using Deterministic Guards.

  # PREAMBLE: This Python code block runs ONCE when the interpreter is initialized.
  # Variables defined here become the "Global Memory" (Context) of the machine.
  preamble: |
    # This is Python code below
    correct_pin = 1234
    
    # You can define helper functions here to keep your YAML logic clean.
    # is_admin() is used in `guard` within `transitions`
    def is_admin(code):
        return code == 9999

  root state:
    name: Active
    initial: Locked

    states:
      - name: Locked
        transitions:
          # 1. Admin Check
          - event: PIN_ENTERED
            # GUARD: A Python boolean expression.
            # 'event.code' comes from interpreter.queue('PIN_ENTERED', code=9999).
            # If this evaluates to True, the transition is taken.
            guard: is_admin(event.code)
            target: Unlocked
            # ACTION: Python code executed during the transition.
            # The pipe '|' (Block Scalar) allows using colons/quotes safely in YAML.
            action: |
              print(">> ADMIN OVERRIDE. Unlocking...")

          # 2. User Success Check
          - event: PIN_ENTERED
            guard: event.code == correct_pin
            target: Unlocked
            action: |
              print(f">> Success! PIN {event.code} accepted.")

          # 3. Failure Check
          # DETERMINISM: Sismic requires that exactly ONE path be valid.
          # We must explicitly exclude Admin and Success cases here using 'and not'.
          # If we just used 'guard: True' (or no guard), this would crash when
          # 'correct_pin' is entered because two paths would be valid simultaneously.
          - event: PIN_ENTERED
            guard: event.code != correct_pin and not is_admin(event.code)
            target: ErrorState
            action: |
              print(f">> FAILURE: PIN {event.code} is incorrect.")

      - name: Unlocked
        transitions:
          - event: LOCK
            target: Locked
            action: print(">> System re-armed.")

      - name: ErrorState
        transitions:
          - event: RESET
            target: Locked
            action: print(">> Error cleared.")